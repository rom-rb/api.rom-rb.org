#!/usr/bin/env ruby

require 'pathname'
require 'fileutils'
require 'yaml'

gh_url = "https://github.com/rom-rb/%{project}.git"
root = Pathname(__dir__).join('..').realpath
clone_to = root.join('gems')
projects = YAML.load_file("data/projects.yaml").map { |p| p['name'] }

projects.each do |project|
  target_dir = clone_to.join(project)
  if target_dir.exist?
    puts "Updating #{target_dir}"
    system "cd #{target_dir} && git pull > /dev/null"
  else
    puts "Cloning #{project} to #{target_dir}"
    system "git clone #{gh_url % { project: project }} #{target_dir} > /dev/null"
  end
end

projects.each do |project|
  doc_output_dir = root.join('docs').join(project)
  project_dir = root.join("gems/#{project}")

  FileUtils.mkdir_p(doc_output_dir) unless doc_output_dir.exist?

  puts "Generating docs for #{project} to #{doc_output_dir}"
  system "cd #{project_dir} && yard -o #{doc_output_dir} -p #{root.join('templates')} > /dev/null && cd #{root}"
end
